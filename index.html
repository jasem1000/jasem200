<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مختبر الحسابات - نموذج التحاليل الطبية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
   * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Cairo', sans-serif;
    line-height: 1.6;
    color: #333;
    background-color: #f5f7fa;
    padding: 20px;
    min-height: 100vh;
}

.container {
    max-width: 1100px;
    margin: 0 auto;
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    position: relative;
}

.header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #4CAF50;
}

.logo-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.logo {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
    border-radius: 50%;
    color: white;
    font-size: 35px;
}

.header-text {
    flex: 1;
}

.header h1 {
    color: #2c7da0;
    font-size: xx-large;
    font-weight: bolder;
    margin-bottom: 5px;
}

.patient-info {
    font-size: medium;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f9f9f9;
}

.info-item {
    font-size: medium;
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
}

.info-label {
    font-weight: bold;
    color: #2c7da0;
}

.editable-field {
    font-weight: bold;
    font-size: medium;
    border: 1px dashed #4CAF50;
    padding: 4px 8px;
    border-radius: 4px;
    min-width: 120px;
    text-align: right;
    background-color: white;
    font-family: 'Cairo', sans-serif;
}

.editable-field:focus {
    outline: none;
    border: 1px solid #2E7D32;
    background-color: #f0fff0;
}

.results-container {
    font-size: larger;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.section {
    margin-bottom: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    background-color: #fff;
    display: none;
}

.section.active {
    display: block;
}

.section-title {
    background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
    color: white;
    padding: 10px 15px;
    font-size: 23px;
    font-weight: bold;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    direction: ltr;
}

th, td {
    border: 1px solid #ddd;
    padding: 8px 6px;
    text-align: center;
}

th {
    background-color: #f2f2f2;
    font-weight: bold;
    color: #2c7da0;
}

.test-name {
    font-size: x-large;
    font-weight: bold;
    background-color: #e8f4e8;
    text-align: left;
    padding-left: 10px;
}

.normal-range {
    font-size: larger;
    font-weight: bold;
    color: #b90f0f;
    direction: ltr;
}

.result-input {
    width: 100%;
    border: 1px dashed #4CAF50;
    padding: 5px;
    border-radius: 4px;
    text-align: center;
    font-family: 'Cairo', sans-serif;
    background-color: #f9f9f9;
    font-size: 16px;
    font-weight: bolder;
    direction: ltr;
}

.result-input:focus {
    outline: none;
    border: 1px solid #2E7D32;
    background-color: #f0fff0;
}

.result-select {
    width: 100%;
    border: 1px dashed #4CAF50;
    padding: 5px;
    border-radius: 4px;
    text-align: center;
    font-family: 'Cairo', sans-serif;
    background-color: #f9f9f9;
    font-size: 13px;
    cursor: pointer;
    direction: ltr;
}

.result-select:focus {
    outline: none;
    border: 1px solid #2E7D32;
    background-color: #f0fff0;
}

.footer {
    text-align: center;
    margin-top: 25px;
    padding-top: 15px;
    border-top: 2px solid #4CAF50;
    color: #666;
    font-size: 14px;
}

.signature-area {
    margin-top: 30px;
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 20px;
}

.signature-box {
    width: 200px;
    border-top: 1px solid #333;
    padding-top: 5px;
    text-align: center;
    font-size: 14px;
}

.signature-input {
    border: none;
    border-bottom: 1px dashed #333;
    padding: 3px;
    text-align: center;
    font-family: 'Cairo', sans-serif;
    width: 100%;
    margin-top: 3px;
    font-size: 13px;
}

.action-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 30px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.btn-print {
    background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
    color: white;
}

.btn-clear {
    background: linear-gradient(135deg, #f44336 0%, #b71c1c 100%);
    color: white;
}

.btn-save {
    background: linear-gradient(135deg, #2c7da0 0%, #1a5e78 100%);
    color: white;
}

.btn-load {
    background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
    color: white;
}

.btn-manage {
    background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
    color: white;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.lab-footer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: #f9f9f9;
    padding: 15px;
    text-align: center;
    border-top: 2px solid #4CAF50;
    font-family: 'Cairo', sans-serif;
    z-index: 1000;
}

.lab-footer-content {
    max-width: 1100px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    font-size: 14px;
}

.lab-footer-item {
    padding: 5px;
}

.lab-footer-title {
    font-weight: bold;
    color: #2E7D32;
    margin-bottom: 5px;
}

.test-selection {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    font-weight: bold;
    color: #2c7da0;
    flex-wrap: wrap;
}

.test-selection label {
    white-space: nowrap;
}

.test-selection select {
    padding: 8px 12px;
    border: 1px solid #4CAF50;
    border-radius: 8px;
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
    cursor: pointer;
    background-color: #f9f9f9;
}

.test-selection select:focus {
    outline: none;
    border-color: #2E7D32;
    box-shadow: 0 0 5px rgba(46, 125, 50, 0.5);
}

/* Print Styles */
@media print {
    @page {
        size: portrait;
        margin: 0.5cm;
    }

    body, html {
        width: 100%;
        height: auto;
        margin: 0;
        padding: 0;
        background: white;
        font-size: 12px;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    body * {
        visibility: visible;
    }

    .container {
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 10px;
        box-shadow: none;
        border-radius: 0;
        flex-grow: 1; /* This pushes the footer down */
    }

    .no-print, .action-buttons, .test-selection {
        display: none !important;
    }

    .section {
        display: block;
        page-break-inside: avoid;
        border: 1px solid #ddd;
        margin-bottom: 10px;
    }

    .header {
        border-bottom: 2px solid #000;
        margin-bottom: 10px;
        padding-bottom: 10px;
    }

    .patient-info {
        border: 1px solid #ddd;
        margin-bottom: 10px;
        padding: 10px;
    }

    .logo {
        background: white;
        color: #4CAF50;
        border: 2px solid #4CAF50;
    }

    .section-title {
        background: #f2f2f2;
        color: #000;
        border-bottom: 1px solid #ddd;
        padding: 8px 12px;
        font-size: 14px;
    }

    .editable-field, .signature-input {
        border: none;
        background-color: transparent;
        padding: 0;
        min-width: unset;
        text-align: right !important;
    }

    .result-input, .result-select {
        border: none;
        background-color: transparent;
        padding: 0;
        min-width: unset;
        text-align: center !important;
        width: 100%;
    }

    .results-container {
        gap: 10px;
    }

    table {
        font-size: 12px;
        direction: ltr;
    }

    th, td {
        padding: 5px 4px;
    }

    .test-name {
        text-align: left;
    }

    .normal-range {
        text-align: center;
    }

    .footer {
        margin-top: 15px;
        padding-top: 10px;
        font-size: 12px;
    }

    .signature-area {
        margin-top: 20px;
        gap: 15px;
    }

    .signature-box {
        width: 180px;
        font-size: 12px;
    }

    .no-print-row, .no-print-item, .no-print-section {
        display: none !important;
    }

    .lab-footer {
        position: relative; /* Change to relative to be part of the flow */
        bottom: unset; /* Remove fixed positioning */
        border-top: 2px solid #000;
        padding: 10px;
        font-size: 12px;
    }

    .lab-footer-content {
        max-width: 100%;
        grid-template-columns: repeat(3, 1fr);
    }

    .lab-footer-item {
        text-align: center;
    }
}

@media (max-width: 600px) {
    .results-container {
        grid-template-columns: 1fr;
    }

    .patient-info {
        grid-template-columns: 1fr;
    }

    .lab-footer-content {
        grid-template-columns: 1fr;
        gap: 5px;
    }
}

.watermark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 60px;
    color: rgba(0, 0, 0, 0.03);
    pointer-events: none;
    z-index: -1;
    font-weight: bold;
    white-space: nowrap;
}

.examiner-name {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background-color: #e8f4e8;
    border-top: 1px solid #ddd;
    font-weight: bold;
    direction: ltr;
}

.examiner-input {
    border: 1px dashed #4CAF50;
    padding: 5px 10px;
    border-radius: 4px;
    text-align: left;
    font-family: 'Cairo', sans-serif;
    width: 200px;
    background-color: white;
}

.sub-section-title {
    background-color: #e8f4e8;
    padding: 8px;
    text-align: center;
    font-weight: bold;
    border-bottom: 1px solid #ddd;
    direction: ltr;
}
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 800px;
    border-radius: 10px;
    direction: rtl;
}

.close {
    color: #aaa;
    float: left;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
}

.normal-range-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: 'Cairo', sans-serif;
}

.range-management {
    margin: 15px 0;
}

.range-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
}

.range-table th, .range-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}

.range-table th {
    background-color: #f2f2f2;
}

.btn-manage {
    background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
    color: white;
}
/* أنماط جديدة للإضافات */
.add-test-btn {
    background: linear-gradient(135deg, #2196F3 0%, #0D47A1 100%);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 5px;
    font-family: 'Cairo', sans-serif;
}

.add-section-btn {
    background: linear-gradient(135deg, #9C27B0 0%, #6A1B9A 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 30px;
    cursor: pointer;
    margin: 15px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Cairo', sans-serif;
    font-weight: bold;
}

.test-controls {
    display: flex;
    justify-content: flex-end;
    padding: 5px 10px;
    background-color: #f5f5f5;
    border-bottom: 1px solid #ddd;
}

.remove-test {
    color: #f44336;
    cursor: pointer;
    font-size: 16px;
    padding: 5px;
}

.modal-tabs {
    display: flex;
    margin-bottom: 15px;
    border-bottom: 1px solid #ddd;
}

.modal-tab {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 3px solid transparent;
}

.modal-tab.active {
    border-bottom: 3px solid #4CAF50;
    color: #4CAF50;
    font-weight: bold;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.new-test-form, .new-section-form {
    display: grid;
    gap: 10px;
    margin: 15px 0;
}

.form-group {
    display: grid;
    grid-template-columns: 1fr 2fr;
    align-items: center;
    gap: 10px;
}

.form-input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-family: 'Cairo', sans-serif;
}

.test-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
}

.test-item {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    border-bottom: 1px solid #eee;
}

.test-item:last-child {
    border-bottom: none;
}
    </style>
</head>
<body>
    <div class="watermark">مختبر الحسابات</div>
    
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-microscope"></i>
                </div>
                <div class="header-text">
                    <h1>  مختبر الحسابات للتحليلات المرضية </h1>
                </div>
            </div>
        </div>
        
        <div class="patient-info" id="patientInfoSection">
            <div class="info-item">
                <span class="info-label">اسم المريض:</span>
                <input type="text" class="editable-field" value="" id="patientName" placeholder="اسم المريض">
            </div>
            <div class="info-item">
                <span class="info-label">العمر:</span>
                <input type="text" class="editable-field" value="" id="patientAge" placeholder="العمر">
            </div>
          
            <div class="info-item">
                <span class="info-label">تاريخ الإجراء:</span>
                <input type="text" class="editable-field" id="currentDate">
            </div>
            <div class="info-item">
                <span class="info-label">الطبيب المعالج:</span>
                <input type="text" class="editable-field" value="" id="doctorName" placeholder="اسم الطبيب">
            </div>
        </div>
        <div class="test-selection no-print">
            <label for="test-select">اختر قسم التحليل:</label>
            <select id="test-select" onchange="showSelectedSection()">
                <option value="chemicalSection">Chemical Tests</option>
                <option value="lipidSection">Lipid Profile</option>
                <option value="bloodSection">Hematology </option>
                <option value="hormoneSection">Hormone Tests</option>
                <option value="serologySection">Serology & Immunology</option>
                <option value="urineSection">General Urine Examination</option>
                </select>
            <button class="add-section-btn" onclick="openAddSectionModal()">
                <i class="fas fa-plus"></i> إضافة قسم جديد
            </button>
        </div>

        <div class="action-buttons no-print">
            <button class="btn btn-print" onclick="printPage()">
                <i class="fas fa-print"></i> طباعة التقرير
            </button>
            <button class="btn btn-save" onclick="savePatientData()">
                <i class="fas fa-save"></i> حفظ البيانات
            </button>
            <button class="btn btn-load" onclick="loadPatientData()">
                <i class="fas fa-search"></i> بحث واستعادة
            </button>
            <button class="btn btn-clear" onclick="clearAllFields()">
                <i class="fas fa-trash"></i> مسح الكل
            </button>
            <button class="btn btn-manage" onclick="openRangeManager()">
                <i class="fas fa-cog"></i> إدارة النطاقات
            </button>
        </div>
        
        <div class="results-container">
            <div class="section" id="chemicalSection">
        <div class="section-title">
            <i class="fas fa-prescription-bottle"></i> Chemical Tests
        </div>
        <table>
            <tr>
                <th>Test</th>
                <th>Result</th>
                <th>Normal Range</th>
            </tr>
            <tr>
                <td class="test-name">F.B.S</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (60-120)</td>
            </tr>
            <tr>
                <td class="test-name">R.B.S</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (110-170)</td>
            </tr>
            <tr>
                <td class="test-name">HbA1C</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">4.8-6.0 %</td>
            </tr>
            <tr>
                <td class="test-name">Vitamin D3</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">ng/ml (30-100)</td>
            </tr>
            <tr>
                <td class="test-name">Na+</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mmol/L (135-155)</td>
            </tr>
            <tr>
                <td class="test-name">K+</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mmol/L (3.6-5.5)</td>
            </tr>
            <tr>
                <td class="test-name">B. Urea</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (15-45)</td>
            </tr>
            <tr>
                <td class="test-name">S. Creatinine</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (0.4-1.1)</td>
            </tr>
            <tr>
                <td class="test-name">eGFR</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">>90 ml/min/1.73m²</td>
            </tr>
            <tr>
                <td class="test-name">Uric acid</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (3-6)</td>
            </tr>
            <tr>
                <td class="test-name">S. Calcium</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (8.5-10.3)</td>
            </tr>
            <tr>
                <td class="test-name">S. Total Protein</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">g/dl (6.6-8.0)</td>
            </tr>
            <tr>
                <td class="test-name">S. Albumin</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">g/dl (3.5-5.5)</td>
            </tr>
            <tr>
                <td class="test-name">Total Bilirubin</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (0.2-1.2)</td>
            </tr>
            <tr>
                <td class="test-name">Direct Bilirubin</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (0-0.3)</td>
            </tr>
            <tr>
                <td class="test-name">Indirect Bilirubin</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (0.2-0.9)</td>
            </tr>
            <tr>
                <td class="test-name">ALT (GPT)</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">U/L (<46)</td>
            </tr>
            <tr>
                <td class="test-name">AST (GOT)</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">U/L (<46)</td>
            </tr>
            <tr>
                <td class="test-name">ALP</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">U/L (40-150)</td>
            </tr>
            <tr>
                <td class="test-name">Amylase</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">U/L (30-110)</td>
            </tr>
            <tr>
                <td class="test-name">Lipase</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">U/L (10-140)</td>
            </tr>
            <tr>
                <td class="test-name">CK</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">U/L (20-200)</td>
            </tr>
            <tr>
                <td class="test-name">CK-MB</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">U/L (<25)</td>
            </tr>
            <tr>
                <td class="test-name">LDH</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">U/L (140-280)</td>
            </tr>
            <tr>
                <td class="test-name">ASOT</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">IU/ml (<200)</td>
            </tr>
        </table>
    </div>

    <div class="section" id="lipidSection">
        <div class="section-title">
            <i class="fas fa-chart-pie"></i> Lipid Profile
        </div>
        <table>
            <tr>
                <th>Test</th>
                <th>Result</th>
                <th>Normal Range</th>
            </tr>
            <tr>
                <td class="test-name">S. Cholesterol</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (150-200)</td>
            </tr>
            <tr>
                <td class="test-name">S. Triglyceride</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (35-165)</td>
            </tr>
            <tr>
                <td class="test-name">VLDL</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (5-30)</td>
            </tr>
            <tr>
                <td class="test-name">S. LDL</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (130-160)</td>
            </tr>
            <tr>
                <td class="test-name">S. HDL</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range">mg/dl (35-65)</td>
            </tr>
            <tr>
                <td class="test-name">Chol/HDL Ratio</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range"><5.0</td>
            </tr>
            <tr>
                <td class="test-name">LDL/HDL Ratio</td>
                <td><input type="text" class="result-input" value=""></td>
                <td class="normal-range"><3.5</td>
            </tr>
        </table>
    </div>

            
            <div class="section" id="bloodSection">
    <div class="section-title">
        <i class="fas fa-tint"></i> Hematology
    </div>
    <table>
        <tr>
            <th>Test</th>
            <th>Result</th>
            <th>Normal Range</th>
        </tr>
        <tr>
            <td class="test-name">HbA1C</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">4.8-6.0%</td>
        </tr>
        <tr>
            <td class="test-name">Hb</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">13-17 g/dl (M), 12-15 g/dl (F)</td>
        </tr>
        <tr>
            <td class="test-name">PCV (Hematocrit)</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">40-54% (M), 36-47% (F)</td>
        </tr>
        <tr>
            <td class="test-name">RBC count</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">4.5-5.9 M/µL (M), 4.1-5.1 M/µL (F)</td>
        </tr>
        <tr>
            <td class="test-name">WBC</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">4,000-11,000 /µL</td>
        </tr>
        <tr>
            <td class="test-name">Platelet count</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">150,000-450,000 /µL</td>
        </tr>
        <tr>
            <td class="test-name">MCV</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">80-100 fl</td>
        </tr>
        <tr>
            <td class="test-name">MCH</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">27-33 pg</td>
        </tr>
        <tr>
            <td class="test-name">MCHC</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">32-36 g/dl</td>
        </tr>
        <tr>
            <td class="test-name">Reticulocyte count</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">0.5-1.5%</td>
        </tr>
        <tr>
            <td class="test-name">ESR</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">0-15 mm/hr (M), 0-20 mm/hr (F)</td>
        </tr>
        <tr>
            <td class="test-name">Blood group</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">ABO + Rh</td>
        </tr>
        <tr>
            <td class="test-name">Bleeding time</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">2-7 min</td>
        </tr>
        <tr>
            <td class="test-name">Clotting time</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">5-15 min</td>
        </tr>
        <tr>
            <td class="test-name">Ferritin</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">30-400 ng/ml (M), 13-150 ng/ml (F)</td>
        </tr>
    </table>
</div>
            
            <div class="section" id="hormoneSection">
    <div class="section-title">
        <i class="fas fa-microscope"></i> Hormone Tests
    </div>
    <table>
        <tr>
            <th>Test</th>
            <th>Result</th>
            <th>Normal Range</th>
        </tr>
        <tr>
            <td class="test-name">T3</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">nmol/L (0.8-2.0)</td>
        </tr>
        <tr>
            <td class="test-name">T4</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">nmol/L (60-120)</td>
        </tr>
        <tr>
            <td class="test-name">TSH</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">µIU/ml (0.4-4.0)</td>
        </tr>
        <tr>
            <td class="test-name">Cortisol</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">µg/dl (Morning 6-23)</td>
        </tr>
        <tr>
            <td class="test-name">LH</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">IU/L</td>
        </tr>
        <tr>
            <td class="test-name">FSH</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">IU/L</td>
        </tr>
        <tr>
            <td class="test-name">Prolactin</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">ng/ml (M: 2-18, F: 3-29)</td>
        </tr>
        <tr>
            <td class="test-name">Testosterone</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">ng/dl (M: 300-1000, F: 15-70)</td>
        </tr>
        <tr>
            <td class="test-name">Estradiol (E2)</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">pg/ml (F: varies by cycle phase, M: 10-50)</td>
        </tr>
        <tr>
            <td class="test-name">Progesterone</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">ng/ml (F: varies by cycle phase)</td>
        </tr>
        <tr>
            <td class="test-name">hCG</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">mIU/ml (Negative in non-pregnant)</td>
        </tr>
        <tr>
            <td class="test-name">Insulin</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">µIU/ml (2-25)</td>
        </tr>
        <tr>
            <td class="test-name">C-Peptide</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">ng/ml (0.5-2.0)</td>
        </tr>
        <tr>
            <td class="test-name">DHEA-S</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">µg/dl (M: 80-560, F: 35-430)</td>
        </tr>
        <tr>
            <td class="test-name">Growth Hormone (GH)</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">ng/ml (0-10)</td>
        </tr>
        <tr>
            <td class="test-name">IGF-1</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">ng/ml (varies by age)</td>
        </tr>
        <tr>
            <td class="test-name">Parathyroid Hormone (PTH)</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">pg/ml (10-65)</td>
        </tr>
    </table>
</div>

          <div class="section" id="serologySection">
    <div class="section-title">
        <i class="fas fa-vial"></i> Serology & Immunology
    </div>
    <table>
        <tr>
            <th>Test</th>
            <th>Result</th>
            <th>Normal Range</th>
        </tr>
        <tr>
            <td class="test-name">Widal Test</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">Widal IgG</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">Widal IgM</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">Rose Bengal (Brucella)</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">H.pylori Ab</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">CRP</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">mg/L (&lt;5)</td>
        </tr>
        <tr>
            <td class="test-name">RF</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">IU/ml (&lt;20)</td>
        </tr>
        <tr>
            <td class="test-name">ASO Titer</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">IU/ml (&lt;200)</td>
        </tr>
        <tr>
            <td class="test-name">Toxo IgG</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">Toxo IgM</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">CMV IgG</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">CMV IgM</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">EBV (VCA IgG)</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">EBV (VCA IgM)</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">HBsAg</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">HBsAb</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">Anti-HCV (HCV-Ab)</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">HIV AB</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">HIV (ELISA)</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">VDRL / RPR (Syphilis)</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">ANA</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">Anti-dsDNA</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">Negative</td>
        </tr>
        <tr>
            <td class="test-name">IgG</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">700-1600 mg/dl</td>
        </tr>
        <tr>
            <td class="test-name">IgA</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">70-400 mg/dl</td>
        </tr>
        <tr>
            <td class="test-name">IgM</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">40-230 mg/dl</td>
        </tr>
        <tr>
            <td class="test-name">IgE</td><td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">&lt;100 IU/ml</td>
        </tr>
        <tr>
            <td class="test-name">C3 Complement</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">90-180 mg/dl</td>
        </tr>
        <tr>
            <td class="test-name">C4 Complement</td>
            <td><input type="text" class="result-input" value=""></td>
            <td class="normal-range">10-40 mg/dl</td>
        </tr>
    </table>
</div>
            
            <div class="section" id="urineSection">
    <div class="section-title">
        <i class="fas fa-flask"></i> General Urine Examination
    </div>
    <table>
        <thead>
            <tr>
                <th>Test</th>
                <th>Result</th>
                <th>Normal Range</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="3" class="sub-section-title">Physical Examination</td>
            </tr>
            <tr>
                <td class="test-name">Color</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Pale Yellow">Pale Yellow</option>
                        <option value="Yellow">Yellow</option>
                        <option value="Dark Yellow">Dark Yellow</option>
                        <option value="Amber">Amber</option>
                        <option value="Orange">Orange</option>
                        <option value="Red/Pink">Red/Pink</option>
                        <option value="Brown">Brown</option>
                        <option value="Blue/Green">Blue/Green</option>
                    </select>
                </td>
                <td class="normal-range">Light Yellow to Yellow</td>
            </tr>
            <tr>
                <td class="test-name">Appearance</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Clear">Clear</option>
                        <option value="Slightly Cloudy">Slightly Cloudy</option>
                        <option value="Cloudy">Cloudy</option>
                        <option value="Turbid">Turbid</option>
                    </select>
                </td>
                <td class="normal-range">Clear</td>
            </tr>
            <tr>
                <td class="test-name">Specific Gravity</td>
                <td>
                    <input type="text" class="result-input" placeholder="e.g., 1.020">
                </td>
                <td class="normal-range">1.005 - 1.030</td>
            </tr>
            <tr>
                <td colspan="3" class="sub-section-title">Chemical Examination (Dipstick)</td>
            </tr>
            <tr>
                <td class="test-name">pH</td>
                <td>
                    <input type="text" class="result-input" placeholder="e.g., 6.0">
                </td>
                <td class="normal-range">4.5 - 8.0</td>
            </tr>
            <tr>
                <td class="test-name">Glucose</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Negative">Negative</option>
                        <option value="Trace">Trace</option>
                        <option value="1+">1+</option>
                        <option value="2+">2+</option>
                        <option value="3+">3+</option>
                        <option value="4+">4+</option>
                    </select>
                </td>
                <td class="normal-range">Negative</td>
            </tr>
            <tr>
                <td class="test-name">Protein</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Negative">Negative</option>
                        <option value="Trace">Trace</option>
                        <option value="1+">1+</option>
                        <option value="2+">2+</option>
                        <option value="3+">3+</option>
                        <option value="4+">4+</option>
                    </select>
                </td>
                <td class="normal-range">Negative</td>
            </tr>
            <tr>
                <td class="test-name">Ketones</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Negative">Negative</option>
                        <option value="Trace">Trace</option>
                        <option value="1+">1+</option>
                        <option value="2+">2+</option>
                        <option value="3+">3+</option>
                        <option value="4+">4+</option>
                    </select>
                </td>
                <td class="normal-range">Negative</td>
            </tr>
            <tr>
                <td class="test-name">Blood</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Negative">Negative</option>
                        <option value="Trace">Trace</option>
                        <option value="1+">1+</option>
                        <option value="2+">2+</option>
                        <option value="3+">3+</option>
                        <option value="4+">4+</option>
                    </select>
                </td>
                <td class="normal-range">Negative</td>
            </tr>
            <tr>
                <td class="test-name">Bilirubin</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Negative">Negative</option>
                        <option value="Positive">Positive</option>
                    </select>
                </td>
                <td class="normal-range">Negative</td>
            </tr>
            <tr>
                <td class="test-name">Urobilinogen</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Normal">Normal</option>
                        <option value="Increased">Increased</option>
                    </select>
                </td>
                <td class="normal-range">Normal</td>
            </tr>
            <tr>
                <td class="test-name">Nitrites</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Negative">Negative</option>
                        <option value="Positive">Positive</option>
                    </select>
                </td>
                <td class="normal-range">Negative</td>
            </tr>
            <tr>
                <td class="test-name">Leukocytes (WBC Esterase)</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Negative">Negative</option>
                        <option value="Trace">Trace</option>
                        <option value="1+">1+</option>
                        <option value="2+">2+</option>
                        <option value="3+">3+</option>
                    </select>
                </td>
                <td class="normal-range">Negative</td>
            </tr>
            <tr>
                <td colspan="3" class="sub-section-title">Microscopic Examination (Sediment)</td>
            </tr>
            <tr>
                <td class="test-name">RBCs</td>
                <td>
                    <input type="text" class="result-input" placeholder="e.g., 1-2 /HPF">
                </td>
                <td class="normal-range">0 - 2 /HPF</td>
            </tr>
            <tr>
                <td class="test-name">WBCs</td>
                <td>
                    <input type="text" class="result-input" placeholder="e.g., 2-4 /HPF">
                </td>
                <td class="normal-range">0 - 5 /HPF</td>
            </tr>
            <tr>
                <td class="test-name">Epithelial Cells</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Few">Few</option>
                        <option value="Moderate">Moderate</option>
                        <option value="Many">Many</option>
                    </select>
                </td>
                <td class="normal-range">Few</td>
            </tr>
            <tr>
                <td class="test-name">Casts</td>
                <td>
                    <input type="text" class="result-input" placeholder="e.g., Hyaline Casts">
                </td>
                <td class="normal-range">Negative</td>
            </tr>
            <tr>
                <td class="test-name">Crystals</td>
                <td>
                    <input type="text" class="result-input" placeholder="e.g., Calcium Oxalate">
                </td>
                <td class="normal-range">Negative</td>
            </tr>
            <tr>
                <td class="test-name">Bacteria</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Negative">Negative</option>
                        <option value="Few">Few</option>
                        <option value="Moderate">Moderate</option>
                        <option value="Many">Many</option>
                    </select>
                </td>
                <td class="normal-range">Negative</td>
            </tr>
            <tr>
                <td class="test-name">Yeast</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Negative">Negative</option>
                        <option value="Positive">Positive</option>
                    </select>
                </td>
                <td class="normal-range">Negative</td>
            </tr>
            <tr>
                <td class="test-name">Mucus threads</td>
                <td>
                    <select class="result-select">
                        <option value="">Select</option>
                        <option value="Few">Few</option>
                        <option value="Moderate">Moderate</option>
                        <option value="Many">Many</option>
                    </select>
                </td>
                <td class="normal-range">Few</td>
            </tr>
        </tbody>
    </table>
</div>
        
        <div class="footer">
            <div class="signature-area">
                
                
            </div>
        </div>
    </div>
            </div>
        
        <div class="footer">
            <div class="lab-footer-content">
            <div class="lab-footer-item">
                <div class="lab-footer-title">مختبر الحسابات</div>
                <div>شكراً لزيارتكم</div>
            </div>
            <div class="lab-footer-item">
                <div class="lab-footer-title">العنوان</div>
                <div>سايدين الحسابات او القادسية الثانيه مقابل ثانويه المستقبل الاهليه</div>
            </div>
            <div class="lab-footer-item">
                <div class="lab-footer-title">رقم الهاتف</div>
                <div>07700733465</div>
            </div>
        </div>
    </div>

        </div>
    </div>
    
    <div id="addSectionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddSectionModal()">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">إضافة قسم وتحاليل جديدة</h2>
            
            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchTab('add-section-tab')">إضافة قسم جديد</div>
                <div class="modal-tab" onclick="switchTab('add-test-tab')">إضافة تحليل لقسم موجود</div>
            </div>
            
            <div id="add-section-tab" class="tab-content active">
                <div class="new-section-form">
                    <div class="form-group">
                        <label>اسم القسم:</label>
                        <input type="text" id="new-section-name" class="form-input" placeholder="أدخل اسم القسم">
                    </div>
                    <div class="form-group">
                        <label>أيقونة القسم:</label>
                        <select id="new-section-icon" class="form-input">
                            <option value="fas fa-vial">أنبوب اختبار</option>
                            <option value="fas fa-tint">دم</option>
                            <option value="fas fa-flask">قارورة</option>
                            <option value="fas fa-microscope">ميكروسكوب</option>
                            <option value="fas fa-prescription-bottle">زجاجة دواء</option>
                            <option value="fas fa-chart-pie">رسم بياني</option>
                        </select>
                    </div>
                    <h3>تحاليل القسم:</h3>
                    <div id="new-section-tests">
                        <div class="test-item">
                            <input type="text" class="form-input test-name-input" placeholder="اسم التحليل">
                            <input type="text" class="form-input test-range-input" placeholder="النطاق الطبيعي">
                            <span class="remove-test" onclick="removeNewTest(this)">×</span>
                        </div>
                    </div>
                    <button class="add-test-btn" onclick="addNewTestField()">
                        <i class="fas fa-plus"></i> إضافة تحليل
                    </button>
                    <button class="btn btn-save" onclick="saveNewSection()">
                        <i class="fas fa-save"></i> حفظ القسم الجديد
                    </button>
                </div>
            </div>
            
            <div id="add-test-tab" class="tab-content">
                <div class="new-test-form">
                    <div class="form-group">
                        <label>اختر القسم:</label>
                        <select id="existing-sections" class="form-input">
                            </select>
                    </div>
                    <div class="form-group">
                        <label>اسم التحليل:</label>
                        <input type="text" id="new-test-name" class="form-input" placeholder="أدخل اسم التحليل">
                    </div>
                    <div class="form-group">
                        <label>النطاق الطبيعي:</label>
                        <input type="text" id="new-test-range" class="form-input" placeholder="أدخل النطاق الطبيعي">
                    </div>
                    <button class="btn btn-save" onclick="saveNewTest()">
                        <i class="fas fa-save"></i> إضافة التحليل
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="rangeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRangeManager()">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px;">إدارة النطاقات الطبيعية للتحاليل</h2>
            
            <div class="range-management">
                <div style="margin-bottom: 15px;">
                    <label for="sectionSelect">اختر قسم التحليل:</label>
                    <select id="sectionSelect" onchange="loadSectionRanges()">
                        </select>
                </div>
                
                <div id="rangeTableContainer">
                    </div>
                
                <div style="text-align: left; margin-top: 20px;">
                    <button class="btn btn-save" onclick="saveRanges()">
                        <i class="fas fa-save"></i> حفظ التعديلات
                    </button>
                    <button class="btn btn-clear" onclick="closeRangeManager()">
                        <i class="fas fa-times"></i> إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="lab-footer">
        </div>

   <script>
// IndexedDB variables
    const DB_NAME = 'LabDatabase';
    const DB_VERSION = 1;
    const STORE_NAME = 'patients';
    let db;

    // Default structure and data
    const defaultLabStructure = [
        { id: 'chemicalSection', title: 'Chemical Tests', icon: 'fas fa-prescription-bottle', tests: {
            "F.B.S": "mg/dl (60-120)", "R.B.S": "mg/dl (110-170)", "HbA1C": "4.8-6.0 %",
            "Vitamin D3": "ng/ml (30-100)", "Na+": "mmol/L (135-155)", "K+": "mmol/L (3.6-5.5)",
            "B. Urea": "mg/dl (15-45)", "S. Creatinine": "mg/dl (0.4-1.1)", "eGFR": ">90 ml/min/1.73m²",
            "Uric acid": "mg/dl (3-6)", "S. Calcium": "mg/dl (8.5-10.3)", "S. Total Protein": "g/dl (6.6-8.0)",
            "S. Albumin": "g/dl (3.5-5.5)", "Total Bilirubin": "mg/dl (0.2-1.2)", "Direct Bilirubin": "mg/dl (0-0.3)",
            "Indirect Bilirubin": "mg/dl (0.2-0.9)", "ALT (GPT)": "U/L (<46)", "AST (GOT)": "U/L (<46)",
            "ALP": "U/L (40-150)", "Amylase": "U/L (30-110)", "Lipase": "U/L (10-140)", "CK": "U/L (20-200)",
            "CK-MB": "U/L (<25)", "LDH": "U/L (140-280)", "ASOT": "IU/ml (<200)"
        }},
        { id: 'lipidSection', title: 'Lipid Profile', icon: 'fas fa-chart-pie', tests: {
            "S. Cholesterol": "mg/dl (150-200)", "S. Triglyceride": "mg/dl (35-165)", "VLDL": "mg/dl (5-30)",
            "S. LDL": "mg/dl (130-160)", "S. HDL": "mg/dl (35-65)", "Chol/HDL Ratio": "<5.0",
            "LDL/HDL Ratio": "<3.5"
        }},
        { id: 'bloodSection', title: 'Hematology', icon: 'fas fa-tint', tests: {
            "HbA1C": "4.8-6.0%", "Hb": "13-17 g/dl (M), 12-15 g/dl (F)", "PCV (Hematocrit)": "40-54% (M), 36-47% (F)",
            "RBC count": "4.5-5.9 M/µL (M), 4.1-5.1 M/µL (F)", "WBC": "4,000-11,000 /µL",
            "Platelet count": "150,000-450,000 /µL", "MCV": "80-100 fl", "MCH": "27-33 pg",
            "MCHC": "32-36 g/dl", "Reticulocyte count": "0.5-1.5%", "ESR": "0-15 mm/hr (M), 0-20 mm/hr (F)",
            "Blood group": "ABO + Rh", "Bleeding time": "2-7 min", "Clotting time": "5-15 min",
            "Ferritin": "30-400 ng/ml (M), 13-150 ng/ml (F)"
        }},
        { id: 'hormoneSection', title: 'Hormone Tests', icon: 'fas fa-microscope', tests: {
            "T3": "nmol/L (0.8-2.0)", "T4": "nmol/L (60-120)", "TSH": "µIU/ml (0.4-4.0)",
            "Cortisol": "µg/dl (Morning 6-23)", "LH": "IU/L", "FSH": "IU/L", "Prolactin": "ng/ml (M: 2-18, F: 3-29)",
            "Testosterone": "ng/dl (M: 300-1000, F: 15-70)", "Estradiol (E2)": "pg/ml (F: varies by cycle phase, M: 10-50)",
            "Progesterone": "ng/ml (F: varies by cycle phase)", "hCG": "mIU/ml (Negative in non-pregnant)",
            "Insulin": "µIU/ml (2-25)", "C-Peptide": "ng/ml (0.5-2.0)", "DHEA-S": "µg/dl (M: 80-560, F: 35-430)",
            "Growth Hormone (GH)": "ng/ml (0-10)", "IGF-1": "ng/ml (varies by age)", "Parathyroid Hormone (PTH)": "pg/ml (10-65)"
        }},
        { id: 'serologySection', title: 'Serology & Immunology', icon: 'fas fa-vial', tests: {
            "Widal Test": "Negative", "Widal IgG": "Negative", "Widal IgM": "Negative", "Rose Bengal (Brucella)": "Negative",
            "H.pylori Ab": "Negative", "CRP": "mg/L (<5)", "RF": "IU/ml (<20)", "ASO Titer": "IU/ml (<200)",
            "Toxo IgG": "Negative", "Toxo IgM": "Negative", "CMV IgG": "Negative", "CMV IgM": "Negative",
            "EBV (VCA IgG)": "Negative", "EBV (VCA IgM)": "Negative", "HBsAg": "Negative", "HBsAb": "Negative",
            "Anti-HCV (HCV-Ab)": "Negative", "HIV AB": "Negative", "HIV (ELISA)": "Negative",
            "VDRL / RPR (Syphilis)": "Negative", "ANA": "Negative", "Anti-dsDNA": "Negative",
            "IgG": "700-1600 mg/dl", "IgA": "70-400 mg/dl", "IgM": "40-230 mg/dl", "IgE": "<100 IU/ml",
            "C3 Complement": "90-180 mg/dl", "C4 Complement": "10-40 mg/dl"
        }},
        { id: 'urineSection', title: 'General Urine Examination', icon: 'fas fa-flask', tests: {
            "Protein": "Negative", "Glucose": "Negative", "Ketones": "Negative", "Bilirubin": "Negative",
            "Urobilinogen": "Normal", "Blood": "Negative", "Nitrites": "Negative", "Leukocytes": "Negative",
            "Color": "Light Yellow", "Appearance": "Clear", "Specific Gravity": "1.015 - 1.025",
            "pH": "4.6 - 8.0", "RBCs": "0-2 / HPF", "WBCs": "0-5 / HPF", "Epithelial Cells": "Few",
            "Crystals": "Negative", "Bacteria": "Negative", "Yeast": "Negative", "Casts": "Negative",
            "Mucus threads": "Few"
        }},
        { id: 'ironSection', title: 'Iron Profile', icon: 'fas fa-heartbeat', tests: {
            "S. Iron": "µg/dl (60-170)", "TIBC": "µg/dl (250-450)", "Transferrin Saturation": "% (20-50)",
            "Ferritin": "ng/ml (M: 20-250, F: 10-120)"
        }}
    ];

    // Functions for managing data
    
    // This object will hold the combined default and custom lab structure
    let labStructure = [];

    // Function to initialize the database
    function initDb() {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = (event) => console.error("IndexedDB error:", event.target.error);
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'patientName' });
            }
        };
        request.onsuccess = (event) => {
            db = event.target.result;
        };
    }
    
    // Function to load and combine all lab data (default and custom)
    function loadLabStructure() {
        const customSections = JSON.parse(localStorage.getItem('customSections')) || {};
        const customTests = JSON.parse(localStorage.getItem('customTests')) || {};

        // Start with the default structure
        labStructure = JSON.parse(JSON.stringify(defaultLabStructure));

        // Add custom sections
        for (const sectionId in customSections) {
            const customSection = customSections[sectionId];
            const tests = {};
            customSection.tests.forEach(test => {
                tests[test.name] = test.range;
            });
            labStructure.push({
                id: sectionId,
                title: customSection.name,
                icon: customSection.icon,
                tests: tests
            });
        }

        // Add custom tests to existing sections
        for (const sectionId in customTests) {
            const existingSection = labStructure.find(sec => sec.id === sectionId);
            if (existingSection) {
                customTests[sectionId].forEach(test => {
                    existingSection.tests[test.name] = test.range;
                });
            }
        }

        renderLabStructure();
        updateSelectMenus();
    }

    // Function to render the lab structure on the page
    function renderLabStructure() {
        const resultsContainer = document.querySelector('.results-container');
        resultsContainer.innerHTML = '';
        
        labStructure.forEach(section => {
            const sectionDiv = document.createElement('div');
            sectionDiv.id = section.id;
            sectionDiv.className = 'section';
            
            // Check if it's the urine analysis section
            if (section.id === 'urineSection') {
                sectionDiv.innerHTML = `
                    <div class="section-title"><i class="${section.icon}"></i> General Urine Examination</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Test</th>
                                <th>Result</th>
                                <th>Normal Range</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="3" class="sub-section-title">Physical Examination</td></tr>
                            <tr>
                                <td class="test-name">Color</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Pale Yellow">Pale Yellow</option>
                                        <option value="Yellow">Yellow</option>
                                        <option value="Dark Yellow">Dark Yellow</option>
                                        <option value="Amber">Amber</option>
                                        <option value="Orange">Orange</option>
                                        <option value="Red/Pink">Red/Pink</option>
                                        <option value="Brown">Brown</option>
                                        <option value="Blue/Green">Blue/Green</option>
                                    </select>
                                </td>
                                <td class="normal-range">Light Yellow to Yellow</td>
                            </tr>
                            <tr>
                                <td class="test-name">Appearance</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Clear">Clear</option>
                                        <option value="Slightly Cloudy">Slightly Cloudy</option>
                                        <option value="Cloudy">Cloudy</option>
                                        <option value="Turbid">Turbid</option>
                                    </select>
                                </td>
                                <td class="normal-range">Clear</td>
                            </tr>
                            <tr>
                                <td class="test-name">Specific Gravity</td>
                                <td><input type="text" class="result-input" placeholder="e.g., 1.020"></td>
                                <td class="normal-range">1.005 - 1.030</td>
                            </tr>
                            <tr><td colspan="3" class="sub-section-title">Chemical Examination (Dipstick)</td></tr>
                            <tr>
                                <td class="test-name">pH</td>
                                <td><input type="text" class="result-input" placeholder="e.g., 6.0"></td>
                                <td class="normal-range">4.5 - 8.0</td>
                            </tr>
                            <tr>
                                <td class="test-name">Glucose</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Negative">Negative</option>
                                        <option value="Trace">Trace</option>
                                        <option value="1+">1+</option>
                                        <option value="2+">2+</option>
                                        <option value="3+">3+</option>
                                        <option value="4+">4+</option>
                                    </select>
                                </td>
                                <td class="normal-range">Negative</td>
                            </tr>
                            <tr>
                                <td class="test-name">Protein</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Negative">Negative</option>
                                        <option value="Trace">Trace</option>
                                        <option value="1+">1+</option>
                                        <option value="2+">2+</option>
                                        <option value="3+">3+</option>
                                        <option value="4+">4+</option>
                                    </select>
                                </td>
                                <td class="normal-range">Negative</td>
                            </tr>
                            <tr>
                                <td class="test-name">Ketones</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Negative">Negative</option>
                                        <option value="Trace">Trace</option>
                                        <option value="1+">1+</option>
                                        <option value="2+">2+</option>
                                        <option value="3+">3+</option>
                                        <option value="4+">4+</option>
                                    </select>
                                </td>
                                <td class="normal-range">Negative</td>
                            </tr>
                            <tr>
                                <td class="test-name">Blood</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Negative">Negative</option>
                                        <option value="Trace">Trace</option>
                                        <option value="1+">1+</option>
                                        <option value="2+">2+</option>
                                        <option value="3+">3+</option>
                                        <option value="4+">4+</option>
                                    </select>
                                </td>
                                <td class="normal-range">Negative</td>
                            </tr>
                            <tr>
                                <td class="test-name">Bilirubin</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Negative">Negative</option>
                                        <option value="Positive">Positive</option>
                                    </select>
                                </td>
                                <td class="normal-range">Negative</td>
                            </tr>
                            <tr>
                                <td class="test-name">Urobilinogen</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Normal">Normal</option>
                                        <option value="Increased">Increased</option>
                                    </select>
                                </td>
                                <td class="normal-range">Normal</td>
                            </tr>
                            <tr>
                                <td class="test-name">Nitrites</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Negative">Negative</option>
                                        <option value="Positive">Positive</option>
                                    </select>
                                </td>
                                <td class="normal-range">Negative</td>
                            </tr>
                            <tr>
                                <td class="test-name">Leukocytes (WBC Esterase)</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Negative">Negative</option>
                                        <option value="Trace">Trace</option>
                                        <option value="1+">1+</option>
                                        <option value="2+">2+</option>
                                        <option value="3+">3+</option>
                                    </select>
                                </td>
                                <td class="normal-range">Negative</td>
                            </tr>
                            <tr><td colspan="3" class="sub-section-title">Microscopic Examination (Sediment)</td></tr>
                            <tr>
                                <td class="test-name">RBCs</td>
                                <td><input type="text" class="result-input" placeholder="e.g., 1-2 /HPF"></td>
                                <td class="normal-range">0 - 2 /HPF</td>
                            </tr>
                            <tr>
                                <td class="test-name">WBCs</td>
                                <td><input type="text" class="result-input" placeholder="e.g., 2-4 /HPF"></td>
                                <td class="normal-range">0 - 5 /HPF</td>
                            </tr>
                            <tr>
                                <td class="test-name">Epithelial Cells</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Few">Few</option>
                                        <option value="Moderate">Moderate</option>
                                        <option value="Many">Many</option>
                                    </select>
                                </td>
                                <td class="normal-range">Few</td>
                            </tr>
                            <tr>
                                <td class="test-name">Casts</td>
                                <td><input type="text" class="result-input" placeholder="e.g., Hyaline Casts"></td>
                                <td class="normal-range">Negative</td>
                            </tr>
                            <tr>
                                <td class="test-name">Crystals</td>
                                <td><input type="text" class="result-input" placeholder="e.g., Calcium Oxalate"></td>
                                <td class="normal-range">Negative</td>
                            </tr>
                            <tr>
                                <td class="test-name">Bacteria</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Negative">Negative</option>
                                        <option value="Few">Few</option>
                                        <option value="Moderate">Moderate</option>
                                        <option value="Many">Many</option>
                                    </select>
                                </td>
                                <td class="normal-range">Negative</td>
                            </tr>
                            <tr>
                                <td class="test-name">Yeast</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Negative">Negative</option>
                                        <option value="Positive">Positive</option>
                                    </select>
                                </td>
                                <td class="normal-range">Negative</td>
                            </tr>
                            <tr>
                                <td class="test-name">Mucus threads</td>
                                <td>
                                    <select class="result-select">
                                        <option value="">Select</option>
                                        <option value="Few">Few</option>
                                        <option value="Moderate">Moderate</option>
                                        <option value="Many">Many</option>
                                    </select>
                                </td>
                                <td class="normal-range">Few</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            } else {
                // Original code for other sections
                let tableHTML = `
                    <div class="section-title"><i class="${section.icon}"></i> ${section.title}</div>
                    <table>
                        <tr>
                            <th>Test</th>
                            <th>Result</th>
                            <th>Normal Range</th>
                        </tr>
                `;
                for (const testName in section.tests) {
                    tableHTML += `
                        <tr>
                            <td class="test-name">${testName}</td>
                            <td><input type="text" class="result-input" value=""></td>
                            <td class="normal-range">${section.tests[testName]}</td>
                        </tr>
                    `;
                }
                tableHTML += `</table>`;
                sectionDiv.innerHTML = tableHTML;
            }
            
            resultsContainer.appendChild(sectionDiv);
        });
        showSelectedSection();
    }

    // Function to update the select menus with sections from the database
    function updateSelectMenus() {
        const testSelect = document.getElementById('test-select');
        const sectionSelectModal = document.getElementById('sectionSelect');
        const sectionForNewTestSelect = document.getElementById('existing-sections');
        
        testSelect.innerHTML = '';
        sectionSelectModal.innerHTML = '';
        sectionForNewTestSelect.innerHTML = '';
        
        labStructure.forEach(section => {
            const option = document.createElement('option');
            option.value = section.id;
            option.textContent = section.title;
            testSelect.appendChild(option);
            
            const option2 = option.cloneNode(true);
            sectionSelectModal.appendChild(option2);
            
            const option3 = option.cloneNode(true);
            sectionForNewTestSelect.appendChild(option3);
        });
    }
    
    // Function to open the range manager modal
    function openRangeManager() {
        document.getElementById('rangeModal').style.display = 'block';
        loadSectionRanges();
    }

    // Function to close the range manager modal
    function closeRangeManager() {
        document.getElementById('rangeModal').style.display = 'none';
    }

    // Function to load ranges of a specific section into the modal
    function loadSectionRanges() {
        const sectionId = document.getElementById('sectionSelect').value;
        const selectedSection = labStructure.find(sec => sec.id === sectionId);
        
        if (!selectedSection) return;

        let tableHTML = `
            <table class="range-table">
                <tr>
                    <th>Test Name</th>
                    <th>Normal Range</th>
                </tr>
        `;
        
        for (const testName in selectedSection.tests) {
            tableHTML += `
                <tr>
                    <td>${testName}</td>
                    <td>
                        <input type="text" class="normal-range-input" 
                            data-section="${sectionId}" 
                            data-test="${testName}" 
                            value="${selectedSection.tests[testName]}">
                    </td>
                </tr>
            `;
        }
        
        tableHTML +=` </table>`;
        document.getElementById('rangeTableContainer').innerHTML = tableHTML;
    }

    // Function to save modified ranges
    function saveRanges() {
        const inputs = document.querySelectorAll('#rangeTableContainer .normal-range-input');
        const customRanges = JSON.parse(localStorage.getItem('customTests')) || {};

        inputs.forEach(input => {
            const sectionId = input.dataset.section;
            const testName = input.dataset.test;
            const rangeValue = input.value.trim();

            const section = labStructure.find(sec => sec.id === sectionId);
            if (section) {
                section.tests[testName] = rangeValue;
            }
            
            // Update localStorage with custom ranges to persist them
            if (sectionId.startsWith('customSection_')) {
                let customSections = JSON.parse(localStorage.getItem('customSections')) || {};
                let currentSection = customSections[sectionId];
                if (currentSection) {
                    let testToUpdate = currentSection.tests.find(test => test.name === testName);
                    if (testToUpdate) {
                        testToUpdate.range = rangeValue;
                    }
                }
                localStorage.setItem('customSections', JSON.stringify(customSections));
            } else {
                if (!customRanges[sectionId]) {
                    customRanges[sectionId] = [];
                }
                const existingTest = customRanges[sectionId].find(test => test.name === testName);
                if (existingTest) {
                    existingTest.range = rangeValue;
                } else {
                    customRanges[sectionId].push({ name: testName, range: rangeValue });
                }
            }
        });

        localStorage.setItem('customTests', JSON.stringify(customRanges));
        loadLabStructure(); // Reload everything to ensure consistency
        alert('Normal ranges saved successfully!');
        closeRangeManager();
    }
    
    // Function to open the add section/test modal
    function openAddSectionModal() {
        document.getElementById('addSectionModal').style.display = 'block';
        populateExistingSections();
    }
    
    // Function to close the add section/test modal
    function closeAddSectionModal() {
        document.getElementById('addSectionModal').style.display = 'none';
    }
    
    // Function to switch between tabs
    function switchTab(tabId) {
        document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        const tabEl = document.querySelector(`.modal-tab[onclick="switchTab('${tabId}')"]`);
        if (tabEl) tabEl.classList.add('active');
        
        document.getElementById(tabId).classList.add('active');
    }
    
    // Function to add a new test field in the modal
    function addNewTestField() {
        const newTestHTML = `
            <div class="test-item">
                <input type="text" class="form-input test-name-input" placeholder="Test Name">
                <input type="text" class="form-input test-range-input" placeholder="Normal Range">
                <span class="remove-test" onclick="removeNewTest(this)">×</span>
            </div>
        `;
        document.getElementById('new-section-tests').insertAdjacentHTML('beforeend', newTestHTML);
    }
    
    // Function to remove a new test field from the modal
    function removeNewTest(element) {
        element.parentElement.remove();
    }
    
    // Function to save a new section
    function saveNewSection() {
        const sectionName = document.getElementById('new-section-name').value.trim();
        const sectionIcon = document.getElementById('new-section-icon').value;
        
        if (!sectionName) {
            alert('Please enter a name for the new section.');
            return;
        }
        
        const sectionId = 'customSection_' + Date.now();
        
        const testInputs = document.querySelectorAll('#new-section-tests .test-item');
        const tests = [];
        
        testInputs.forEach(testItem => {
            const nameInput = testItem.querySelector('.test-name-input');
            const rangeInput = testItem.querySelector('.test-range-input');
            
            if (nameInput.value.trim() && rangeInput.value.trim()) {
                tests.push({
                    name: nameInput.value.trim(),
                    range: rangeInput.value.trim()
                });
            }
        });
        
        if (tests.length === 0) {
            alert('Please enter at least one test for the new section.');
            return;
        }
        
        let customSections = JSON.parse(localStorage.getItem('customSections')) || {};
        customSections[sectionId] = {
            name: sectionName,
            icon: sectionIcon,
            tests: tests
        };
        localStorage.setItem('customSections', JSON.stringify(customSections));
        
        loadLabStructure();
        
        document.getElementById('new-section-name').value = '';
        document.getElementById('new-section-tests').innerHTML = `
            <div class="test-item">
                <input type="text" class="form-input test-name-input" placeholder="Test Name">
                <input type="text" class="form-input test-range-input" placeholder="Normal Range">
                <span class="remove-test" onclick="removeNewTest(this)">×</span>
            </div>
        `;
        
        alert('New section added successfully!');
        closeAddSectionModal();
    }
    
    // Function to populate the existing sections dropdown
    function populateExistingSections() {
        const existingSectionsSelect = document.getElementById('existing-sections');
        existingSectionsSelect.innerHTML = '';
        
        labStructure.forEach(section => {
            const option = document.createElement('option');
            option.value = section.id;
            option.textContent = section.title;
            existingSectionsSelect.appendChild(option);
        });
    }
    
    // Function to save a new test to an existing section
    function saveNewTest() {
        const sectionId = document.getElementById('existing-sections').value;
        const testName = document.getElementById('new-test-name').value.trim();
        const testRange = document.getElementById('new-test-range').value.trim();
        
        if (!testName || !testRange) {
            alert('Please enter both the test name and the normal range.');
            return;
        }
        
        let customTests = JSON.parse(localStorage.getItem('customTests')) || {};
        if (!customTests[sectionId]) {
            customTests[sectionId] = [];
        }
        customTests[sectionId].push({ name: testName, range: testRange });
        localStorage.setItem('customTests', JSON.stringify(customTests));
        
        loadLabStructure();
        
        document.getElementById('new-test-name').value = '';
        document.getElementById('new-test-range').value = '';
        
        alert('New test added successfully!');
    }

    // Function to save patient data to IndexedDB
    function savePatientData() {
        const patientName = document.getElementById('patientName').value.trim();
        if (!patientName) {
            alert('Please enter the patient name first.');
            return;
        }

        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);

        const patientData = {
            patientName: patientName,
            patientAge: document.getElementById('patientAge').value,
            patientGender: document.getElementById('patientGender').value,
            currentDate: document.getElementById('currentDate').value,
            doctorName: document.getElementById('doctorName').value,
            tests: {}
        };

        const allSections = document.querySelectorAll('.section');
        allSections.forEach(section => {
            const sectionId = section.id;
            patientData.tests[sectionId] = {};
            
            const rows = section.querySelectorAll('tr');
            rows.forEach(row => {
                const testNameElement = row.querySelector('.test-name');
                const resultInput = row.querySelector('.result-input, .result-select');

                if (testNameElement && resultInput) {
                    const testName = testNameElement.textContent.trim();
                    const resultValue = resultInput.value.trim();
                    if (resultValue) {
                        patientData.tests[sectionId][testName] = resultValue;
                    }
                }
            });
        });

        const request = store.put(patientData);

        request.onsuccess = () => {
            alert('Patient data saved successfully!');
        };

        request.onerror = (event) => {
            console.error("Save error:", event.target.error);
            alert('Failed to save data. Please try again.');
        };
    }

    // Function to load patient data from IndexedDB
    function loadPatientData() {
        const patientName = prompt('Please enter the patient name to search:');
        if (!patientName) return;

        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(patientName);

        request.onsuccess = (event) => {
            const patientData = event.target.result;
            if (patientData) {
                document.getElementById('patientName').value = patientData.patientName || '';
                document.getElementById('patientAge').value = patientData.patientAge || '';
                document.getElementById('patientGender').value = patientData.patientGender || '';
                document.getElementById('currentDate').value = patientData.currentDate || '';
                document.getElementById('doctorName').value = patientData.doctorName || '';

                document.querySelectorAll('.result-input, .result-select').forEach(input => {
                    input.value = '';
                });
                
                for (const sectionId in patientData.tests) {
                    const tests = patientData.tests[sectionId];
                    for (const testName in tests) {
                        const testRows = document.querySelectorAll('#' + sectionId + ' .test-name');
                        for (let row of testRows) {
                            if (row.textContent.trim() === testName) {
                                const input = row.closest('tr').querySelector('.result-input, .result-select');
                                if (input) {
                                    input.value = tests[testName];
                                }
                                break;
                            }
                        }
                    }
                }

                alert('Patient data restored successfully!');
            } else {
                alert('No data found for this patient.');
            }
        };

        request.onerror = (event) => {
            console.error("Load error:", event.target.error);
            alert('Failed to restore data.');
        };
    }

    // Other existing functions
    function setCurrentDate() {
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        const dateString = now.toLocaleDateString('en-US', options);
        document.getElementById('currentDate').value = dateString;
    }
    
    function showSelectedSection() {
        const sections = document.querySelectorAll('.section');
        const selectedSectionId = document.getElementById('test-select').value;
        sections.forEach(section => {
            if (section.id === selectedSectionId) {
                section.classList.add('active');
            } else {
                section.classList.remove('active');
            }
        });
    }

    function clearAllFields() {
        if(confirm('Are you sure you want to clear all fields?')) {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.value = '';
            });
            
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                select.selectedIndex = 0;
            });
            
            setCurrentDate();
            showSelectedSection();
        }
    }
    
    function prepareForPrint() {
        const allSections = document.querySelectorAll('.section');
        allSections.forEach(section => {
            section.classList.add('active');
        });

        const allResultInputs = document.querySelectorAll('.result-input, .result-select');
        allResultInputs.forEach(input => {
            const row = input.closest('tr');
            if ((input.value.trim() === '' || (input.tagName === 'SELECT' && input.selectedIndex === 0)) && row) {
                row.classList.add('no-print-row');
            } else {
                row.classList.remove('no-print-row');
            }
        });
        
        const patientInfoInputs = document.querySelectorAll('#patientInfoSection .editable-field');
        patientInfoInputs.forEach(input => {
            const infoItem = input.closest('.info-item');
            if (input.value.trim() === '' && infoItem) {
                infoItem.classList.add('no-print-item');
            } else {
                infoItem.classList.remove('no-print-item');
            }
        });
        
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => {
            const inputsInSection = section.querySelectorAll('input, select');
            let hasValue = false;
            
            inputsInSection.forEach(input => {
                if (input.value.trim() !== '' || (input.tagName === 'SELECT' && input.selectedIndex > 0)) {
                    hasValue = true;
                }
            });
            
            if (!hasValue) {
                section.classList.add('no-print-section');
            } else {
                section.classList.remove('no-print-section');
            }
        });
    }
    
    function restoreAfterPrint() {
        const hiddenElements = document.querySelectorAll('.no-print-row, .no-print-item, .no-print-section');
        hiddenElements.forEach(element => {
            element.classList.remove('no-print-row', 'no-print-item', 'no-print-section');
        });
        showSelectedSection();
    }
    
    function printPage() {
        prepareForPrint();
        window.print();
    }
    
    if (window.matchMedia) {
        const mediaQueryList = window.matchMedia('print');
        mediaQueryList.addListener(function(mql) {
            if (!mql.matches) {
                restoreAfterPrint();
            }
        });
    } else {
        window.onafterprint = restoreAfterPrint;
    }

    // Page initialization
    document.addEventListener('DOMContentLoaded', function() {
        setCurrentDate();
        initDb();
        loadLabStructure();
    });
    </script>
</body>

</html>
